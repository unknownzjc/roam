在 k8s 中，后端程序按微服务的形式独立部署在各自的 pod 上，这样的好处是能够享受滚动升级，快速回滚等好处。前端在刚开始 saas 化的时候并非是独立打包镜像部署的，而是让运维手动的将制品拷入容器内替换然后升级。这样带来的坏处是无法追踪，有好几次在预发布演示的时候都发生过没替换导致用的旧制品的情况出现。
为了解决运维手动拷贝的问题，需要将前端产物也接入后端的发布流程，将我们的产物也容器化处理，由交付静态资源包变成交付 Docker 镜像和 helm 包的形式。这样处理之后，前端实际上也能支持线上的快速回滚。
考虑到我们的静态资源产物后续可能会托管到 CDN ,因此静态资源和 html 文件拆分部署。同时我们需要支持多租户+灰度发布的场景，那么就会带来一个问题，html 文件如何进行正确的寻址？这个问题的解我们是通过在资源路径上加上 version 来解决的，对象存储上支持多个版本的产物共存，自然解决了多个租户访问的问题而且天然的支持灰度发布，只需后端的 ingress 将流量导向不同的 html 页面就能做金丝雀发布。不过这样的做法也会带来问题，由于静态资源路径会随着版本变更，浏览器的缓存自然失效。不过权衡之下，我们还是选择了这种方案。
## 版本号方案
版本号的制定我们采用业界的 semver 命名方式，这个版本号会同时作用在 helm 包的和 Docker 镜像的命名上。在迭代发布前，在 git 上打上对应的版本 tag，自动出镜像产物，然后提工单部署。