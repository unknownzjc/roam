在团队中，持续集成主要会包含几个流程：质量门禁检查-构建编译-制品处理
在敏捷模式下，同个团队多个特性会在一天内构建部署很多次，建立一套完善的自动化持续部署流程能够更好的帮助其他人员去进行开发工作。由于团队内的人数比较多，因此在建立流程之前，我们通常会先进行规范的制定。这里主要是包括 git 的分支管理规范和 git commit 规范。
在持续部署的过程中，其实是很依赖于我们的分支规范的，例如我们按 git flow 的模式去约定 release 用来发布正式包，feature/feat 开头的分支用来开发功能，develop 开头的分支是特性组迭代的主分支等等，有了这些约束，我们自然能够进行更加精细化的控制。比如只针对功能分支进行门禁检查，只针对发布包进行构建产物的校验等等。
## 质量门禁
在本地推分支之前一般会先进行一轮静态的代码扫描，借用的工具主要是 ESLint + CommitLint。团队内的格式化工具用的 prettier，在提交之前会通过 husky 进行 eslint fix，会借助 prettier 进行自动修复等，避免把低级错误提交到主干分支上。
在构建产物生成后，同样会进行一轮产物完整性的检查，避免产物残缺发布后页面出现问题，主要检查的是关键的js，css 等是否缺少。
## 构建流程
项目的主要模式是 monorepo 形式的微前端项目，在一次构建中，通常需要构建至少 10 个 app，为了支撑快速迭代，我们针对构建进行提速，构建缓慢的原因我们分析主要是依赖安装久以及 app 串行构建时间长。第一个问题我们引入的解决方案是改造项目为 [[monorepo]] 并且引入 [[pnpm]] 进行依赖的共享。第二个问题我们的解法是引入 docker 多容器构建 + 容器内多线程构建的方式去解决。在我们的 CI 流水线中，引入了3个容器队列进行打包，通过 shell 脚本拆分每个容器的构建 app。但是我们并不满足于此，我们期望尽可能的榨干容器的性能，因此我们瞄准了多线程，在刚开始的时候引入了 Python ，借助协程的功能，在一个容器内支持了多个 app 同时打包，但是后面发现构建产物有问题，所以我们又切换回shell，利用 shell 的多线程能力去做打包。由于我们是多容器打包，因此在容器打包完之后需要对产物进行合并以及校验，整个构建流程方才结束。至此通过这两个解决手段，我们成功的将构建时间由 20 min 缩短到 6 min 左右。
## 制品处理
在构建完之后，由于需要支持多租户方案，因此将产物拆分成 html 和 js，css 。这两种分别打包成不同的镜像部署。
## CI 部署的体验优化
引入更多的机器人，在实践中，我们引入了代码合并机器人，产物打包提醒机器人等，在会影响交付速度的节点上尽可能减少等待的时间。

## Ref
[Git 工作流程](https://www.ruanyifeng.com/blog/2015/12/git-workflow.html)
[Angular commit](https://www.conventionalcommits.org/en/v1.0.0-beta.4/)
[[前端部署容器化及多租户隔离]]